# 存储偏好功能测试指南

## 🎯 修复内容

**问题**：复选框"始终使用本地存储（不尝试云端）"点击无反应

**修复**：
- ✅ 添加了 React 状态管理
- ✅ 实现了实时 UI 更新
- ✅ 添加了用户友好的反馈提示
- ✅ 改善了复选框样式和交互

## 🧪 测试步骤

### **1. 基本功能测试**

1. **打开个人设置**
   - 点击用户头像菜单
   - 选择"个人设置"

2. **查看存储偏好选项**
   - 在"基本信息"标签页
   - 找到头像上传区域下方的复选框
   - 应该显示："始终使用本地存储（不尝试云端）"

3. **测试复选框交互**
   - 点击复选框
   - ✅ 应该立即看到勾选状态变化
   - ✅ 应该弹出提示消息

### **2. 功能验证测试**

#### **测试场景 A：启用本地存储**

1. **勾选复选框**
   - 点击"始终使用本地存储"复选框
   - 应该显示：✅ 勾选状态
   - 应该弹出提示："存储偏好已更新 - 将使用本地存储保存头像"

2. **上传头像测试**
   - 点击"上传头像"按钮
   - 选择一张图片
   - 应该显示："头像已更新"（不会尝试云端）

#### **测试场景 B：禁用本地存储**

1. **取消勾选复选框**
   - 再次点击复选框取消勾选
   - 应该显示：☐ 未勾选状态
   - 应该弹出提示："存储偏好已更新 - 将尝试使用云端存储保存头像"

2. **上传头像测试**
   - 点击"上传头像"按钮
   - 选择一张图片
   - 应该显示："已保存到本地（云端存储不可用）"（会尝试云端但降级）

### **3. 持久化测试**

1. **设置偏好**
   - 勾选"始终使用本地存储"
   - 点击"保存更改"

2. **重新打开设置**
   - 关闭个人设置对话框
   - 重新打开个人设置
   - ✅ 复选框应该保持勾选状态

3. **刷新页面测试**
   - 刷新浏览器页面
   - 重新登录并打开个人设置
   - ✅ 复选框应该保持之前的设置

### **4. 边界情况测试**

#### **测试场景 C：无 Supabase 环境**

如果没有配置 Supabase：
- 复选框不应该显示
- 头像上传应该直接使用 Base64
- 不应该有存储选择的概念

#### **测试场景 D：快速切换**

1. 快速点击复选框多次
2. ✅ 每次点击都应该有响应
3. ✅ 状态应该正确切换
4. ✅ 提示消息应该正确显示

## 🎨 UI 改进验证

### **复选框样式**
- ✅ 有清晰的边框和颜色
- ✅ 勾选时有蓝色高亮
- ✅ 鼠标悬停有反馈

### **标签交互**
- ✅ 点击标签文字也能切换复选框
- ✅ 鼠标悬停时显示指针光标
- ✅ 文字不可选中（避免意外选择）

### **提示消息**
- ✅ 勾选时：提示使用本地存储
- ✅ 取消勾选时：提示尝试云端存储
- ✅ 消息清晰易懂

## 🔧 技术实现验证

### **状态管理**
```javascript
// 应该有以下状态
const [forceBase64Storage, setForceBase64Storage] = useState(false)

// 应该有处理函数
const handleStoragePreferenceChange = (useBase64: boolean) => {
  // 更新状态和 localStorage
}
```

### **持久化存储**
```javascript
// 设置时
localStorage.setItem('force_base64_avatar', 'true')

// 读取时
localStorage.getItem('force_base64_avatar') === 'true'
```

### **上传逻辑**
```javascript
// 应该根据状态决定存储方式
const shouldForceBase64 = !supabase || forceBase64Storage
```

## 🐛 常见问题排查

### **问题 1：复选框仍然无反应**
**检查**：
- 浏览器控制台是否有错误
- React 开发工具中状态是否更新
- 是否在正确的环境中测试

### **问题 2：设置不持久化**
**检查**：
- 浏览器是否允许 localStorage
- 是否在隐私模式下测试
- localStorage 中是否有对应的键值

### **问题 3：提示消息不显示**
**检查**：
- toast 组件是否正常工作
- 是否有其他错误阻止执行
- 网络连接是否正常

## ✅ 预期结果

修复完成后，您应该能够：

1. **正常切换存储偏好**
   - 复选框响应点击
   - 状态实时更新
   - 设置持久保存

2. **获得清晰反馈**
   - 每次操作都有提示
   - 上传结果明确显示
   - 用户体验流畅

3. **功能完全可用**
   - 本地存储模式正常
   - 云端存储尝试正常
   - 智能降级机制正常

---

## 🎉 测试完成

如果所有测试都通过，说明存储偏好功能已经完全修复！您现在可以：
- ✅ 自由选择存储方式
- ✅ 享受流畅的用户体验
- ✅ 获得清晰的操作反馈
